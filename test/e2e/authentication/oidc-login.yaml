---
apiVersion: v1
kind: Pod
metadata:
  name: oidc-login
  labels:
    app.kubernetes.io/name: oidc-login
spec:
  containers:
  - name: oidc-login
    image: quay.io/zncdatadev/testing-tools:0.1.0-kubedoop0.0.0-dev
    resources:
      limits:
        memory: "64Mi"
        cpu: "100m"
      requests:
        memory: "32Mi"
        cpu: "50m"
    env:
      - name: OIDC_TRINO_USERNAME
        value: ($OIDC_TRINO_USERNAME)
      - name: OIDC_TRINO_PASSWORD
        value: ($OIDC_TRINO_PASSWORD)
      - name: REQUESTS_CA_BUNDLE
        value: /kubedoop/tls/ca.crt
      - name: NAMESPACE
        valueFrom:
          fieldRef:
            fieldPath: metadata.namespace
    command:
    - /bin/sh
    - -c
    - |
      # Execute the script
      python /scripts/oidc-login.py https://test-trino-coordinator-default.$NAMESPACE.svc.cluster.local:8443/ui/
    volumeMounts:
    - name: scripts
      mountPath: /scripts
      readOnly: true
    - name: tls
      mountPath: /kubedoop/tls
      readOnly: true
  restartPolicy: Never
  volumes:
  - name: scripts
    configMap:
      name: trino-script
  - name: tls
    csi:
      driver: secrets.kubedoop.dev
      volumeAttributes:
        secrets.kubedoop.dev/class: tls
        secrets.kubedoop.dev/scope: pod
status:
  phase: Succeeded
