apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: authentication
spec:
  bindings:
  - name: LDAP_TRINO_USERNAME
    value: trino
  - name: LDAP_TRINO_PASSWORD
    value: trino123
  - name: KEYCLOAK_REALM
    value: kubedoop
  - name: KEYCLOAK_CLIENT_ID
    value: auth2-proxy
  - name: KEYCLOAK_CLIENT_SECRET
    value: auth2-proxy
  - name: OIDC_TRINO_USERNAME
    value: trino
  - name: OIDC_TRINO_PASSWORD
    value: trino123
  steps:
  - name: install ldap
    try:
    - apply:
        file: ldap-install.yaml
    - assert:
        file: ldap-install-assert.yaml
  - name: install keycloak
    try:
    - apply:
        file: keycloak-install.yaml
    - assert:
        timeout: 4m
        file: keycloak-install-assert.yaml
  - name: deploy authentication classes
    try:
    - apply:
        file: ldap-authenticationclass.yaml
    - apply:
        file: keycloak-authenticationclass.yaml
    - assert:
        file: authenticationclass-assert.yaml
  - name: install trino cluster
    try:
    - apply:
        file: trino.yaml
    - assert:
        file: trino-assert.yaml
  - name: test trino oidc authentication
    try:
    - script:
        env:
          - name: NAMESPACE
            value: ($namespace)
        content: kubectl -n $NAMESPACE create configmap trino-script --from-file=oidc-login.py
    - apply:
        file: oidc-login.yaml
    - assert:
        file: oidc-login-assert.yaml
    catch:
      - describe:
          apiVersion: trino.kubedoop.dev/v1alpha1
          kind: TrinoCluster
      - get:
          apiVersion: trino.kubedoop.dev/v1alpha1
          kind: TrinoCluster
      - podLogs:
          selector: app.kubernetes.io/name=trino-operator
  # TODO: Add more tests for LDAP authentication, but for now, we only test OIDC authentication, the ldap authentication is not working yet
